
```dataviewjs
/* LifeBook Engine V6.5: Performance Refined (StringBuilder + Token Est.) */

// ============================================================ 
// âš™ï¸ æ ¸å¿ƒé…ç½®åŒº (Configuration)
// ============================================================ 
const LB_CONFIG = {
    dir: "1.äººç”Ÿä¹¦/2.æ—¥è®°",
    months: 1 // å›æº¯æœˆä»½ (å»ºè®®ï¼šé•¿æœŸå›é¡¾è®¾ä¸º12)
};

// é™æ€æ­£åˆ™é¢„ç¼–è¯‘ (Performance Optimization)
// é¢„å…ˆç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ä»¥æé«˜å¤šæ¬¡åŒ¹é…æ—¶çš„æ€§èƒ½
const REGEX_Q = /(\d{4})å¹´Q(\d)/;
const REGEX_M = /(\d{4})å¹´(\d{1,2})æœˆ/;
const REGEX_W = /(\d{4})å¹´(\d{1,2})æœˆ.*[Ww](\d+)/;
const REGEX_DATE = /^\d{4}-\d{2}-\d{2}$/;

// ============================================================ 
// ğŸ› ï¸ æ ¸å¿ƒå¤„ç†å‡½æ•° (Core Processor)
// ============================================================ 
async function processLifeBook(config) {
    const now = moment();
    // è®¡ç®—å›æº¯çš„èµ·å§‹æ—¥æœŸ
    const startDate = now.clone().subtract(config.months, 'months').startOf('month');

    // 1. è·å–æ‰€æœ‰é¡µé¢å¯¹è±¡ (Fetch Pages)
    let allPages = dv.pages(`"${config.dir}"`);
    let qList = [], mList = [], wList = [], dList = [];

    // 2. éå†ä¸åˆæ­¥ç­›é€‰ (Traverse & Filter)
    // å°†æ–‡ä»¶æŒ‰ç±»å‹ï¼ˆå­£åº¦/æœˆ/å‘¨/æ—¥ï¼‰æ”¾å…¥ä¸åŒçš„ä¸´æ—¶æ¡¶ä¸­
    for (let p of allPages) {
        const name = p.file.name;

        // A. å­£åº¦æ€»ç»“ (Quarterly Summary)
        // åŒ¹é…æ ¼å¼å¦‚ "2025å¹´Q1æ€»ç»“..."
        if (name.includes("å¹´Q") && name.includes("æ€»ç»“") && name.startsWith("0-")) {
            const match = name.match(REGEX_Q);
            if (match) {
                let y = parseInt(match[1]);
                let q = parseInt(match[2]);
                let qEndM = q * 3;
                let qEndDate = moment(`${y}-${qEndM}`, "YYYY-M").endOf('month');
                if (qEndDate.isAfter(startDate)) {
                    qList.push({ p: p, y: y, q: q, sortKey: `${y}-${q}Q` });
                }
            }
            continue;
        }

        // B. æœˆåº¦æ€»ç»“ (Monthly Summary)
        // åŒ¹é…æ ¼å¼å¦‚ "2025å¹´3æœˆæ€»ç»“..."
        if (name.includes("æœˆæ€»ç»“") && name.startsWith("0-") && !name.includes("å‘¨") && !name.includes("W")) {
            const match = name.match(REGEX_M);
            if (match) {
                let mDate = moment(`${match[1]}-${match[2]}`, "YYYY-M").endOf('month');
                if (mDate.isAfter(startDate)) {
                    mList.push({ p: p, y: parseInt(match[1]), m: parseInt(match[2]), sortKey: `${match[1]}${match[2].padStart(2,'0')}` });
                }
            }
            continue;
        }

        // C. å‘¨åº¦æ€»ç»“ (Weekly Summary)
        // åŒ¹é…æ ¼å¼å¦‚ "2025å¹´3æœˆW1æ€»ç»“..."
        if (name.includes("æ€»ç»“") && (name.includes("å‘¨") || name.includes("W"))) {
             const match = name.match(REGEX_W);
             if (match) {
                 let wEnd = moment(`${match[1]}-${match[2]}`, "YYYY-M").startOf('month').add(parseInt(match[3]) - 1, 'weeks').endOf('isoWeek');
                 if (wEnd.isAfter(startDate)) {
                     let monthKey = wEnd.format("YYYYMM"); // è®°å½•æ‰€å±æœˆä»½Keyï¼Œç”¨äºåç»­å»é‡
                     wList.push({ p: p, name: name, wEnd: wEnd, monthKey: monthKey });
                 }
             }
             continue;
        }

        // D. æ—¥è®° (Daily Journal)
        // åŒ¹é…æ ¼å¼å¦‚ "2025-03-25"
        if (!name.includes("æ€»ç»“") && REGEX_DATE.test(name)) {
            let dDate = moment(name.substring(0, 10));
            if (dDate.isValid() && dDate.isAfter(startDate)) {
                 let monthKey = dDate.format("YYYYMM"); // è®°å½•æ‰€å±æœˆä»½Key
                 dList.push({ p: p, name: name, date: dDate, monthKey: monthKey });
            }
            continue;
        }
    }

    // 3. é€»è¾‘æŠ˜å ä¸çº§è”å›é€€ (Cascading Filter & Fallback)
    // æ ¸å¿ƒæ€æƒ³ï¼šå¦‚æœå­˜åœ¨é«˜å±‚çº§çš„æ€»ç»“ï¼Œåˆ™éšè—ä½å±‚çº§çš„è¯¦æƒ…ï¼›å¦‚æœç¼ºå¤±ï¼Œåˆ™è‡ªåŠ¨å±•ç¤ºæ›´ç»†ç²’åº¦çš„å†…å®¹ã€‚
    
    // Step 3.1: å­£åº¦ -> æœˆä»½
    // è®¡ç®—è¢«å­£åº¦æ€»ç»“è¦†ç›–çš„æœˆä»½
    let coveredMonths = new Set();
    for (let qItem of qList) {
        let startM = (qItem.q - 1) * 3 + 1;
        // ä¸€ä¸ªå­£åº¦è¦†ç›–3ä¸ªæœˆ
        for (let i = 0; i < 3; i++) coveredMonths.add(`${qItem.y}${(startM + i).toString().padStart(2,'0')}`);
    }

    // è¿‡æ»¤æ‰å·²è¢«å­£åº¦æ€»ç»“è¦†ç›–çš„æœˆåº¦æ€»ç»“
    let visibleMonths = mList.filter(m => !coveredMonths.has(m.sortKey));
    
    // æ›´æ–°æ€»çš„è¦†ç›–æœˆä»½é›†åˆï¼ˆåŒ…å«è¢«å­£åº¦è¦†ç›–çš„ + å®é™…æ˜¾ç¤ºçš„æœˆåº¦æ€»ç»“ï¼‰
    let allCoveredMonths = new Set(coveredMonths);
    visibleMonths.forEach(m => allCoveredMonths.add(m.sortKey));

    // Step 3.2: æœˆä»½ -> å‘¨åº¦
    // å¦‚æœæŸä¸ªæœˆä»½å·²è¢«è¦†ç›–ï¼ˆæœ‰å­£åº¦æˆ–æœˆåº¦æ€»ç»“ï¼‰ï¼Œåˆ™éšè—è¯¥æœˆä¸‹çš„å‘¨æ€»ç»“
    let visibleWeeks = wList.filter(w => !allCoveredMonths.has(w.monthKey));

    // è®¡ç®— Cutoff Date (æˆªæ­¢æ—¥æœŸ)
    // å¯¹äºå·²ç»æ˜¾ç¤ºäº†å‘¨æ€»ç»“çš„æ—¶é—´æ®µï¼Œä¸å†æ˜¾ç¤ºè¯¥æ—¶é—´æ®µä¹‹å‰çš„æ—¥è®°
    let cutoff = "0000-00-00";
    for (let w of visibleWeeks) {
        let wEndStr = w.wEnd.format("YYYY-MM-DD");
        if (wEndStr > cutoff) cutoff = wEndStr;
    }

    // Step 3.3: å‘¨åº¦ -> æ—¥è®°
    // è¿‡æ»¤æ—¥è®°ï¼š
    // 1. å¦‚æœè¯¥æ—¥è®°æ‰€å±æœˆä»½å·²æœ‰æ€»ç»“ï¼ˆå­£åº¦/æœˆï¼‰ï¼Œä¸æ˜¾ç¤º
    // 2. å¦‚æœè¯¥æ—¥è®°æ—¥æœŸåœ¨å¯è§å‘¨æ€»ç»“çš„èŒƒå›´å†…ï¼ˆ<= cutoffï¼‰ï¼Œä¸æ˜¾ç¤º
    let visibleDailies = dList.filter(d => {
        if (allCoveredMonths.has(d.monthKey)) return false;
        if (d.name.substring(0, 10) <= cutoff) return false;
        return true;
    });

    // 4. å¹¶å‘åŠ è½½å†…å®¹ (Concurrent IO)
    // å¹¶è¡Œè¯»å–æ‰€æœ‰ç­›é€‰åçš„æ–‡ä»¶å†…å®¹ï¼Œæé«˜æ€§èƒ½
    let ioPromises = [];
    qList.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'quarter', name: "ğŸ† " + x.p.file.name, content: c, path: x.p.file.path }))));
    visibleMonths.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'month', name: "ğŸŒ™ " + x.p.file.name, content: c, path: x.p.file.path }))));
    visibleWeeks.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'week', name: "ğŸ“† " + x.p.file.name, content: c, path: x.p.file.path }))));
    visibleDailies.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'daily', name: "ğŸ“ " + x.p.file.name, content: c, path: x.p.file.path }))));

    let results = await Promise.all(ioPromises);
    results.sort((a, b) => a.path.localeCompare(b.path)); // æŒ‰è·¯å¾„æ’åº

    // 5. ç»“æœæ–‡æœ¬æ„å»º (StringBuilder)
    let textParts = [`# ğŸ“– LifeBook æ•°æ®å›é¡¾\n\n`];
    let meta = { q: [], m: [], w: [], d: [] };
    
    for (let f of results) {
        textParts.push(`## ${f.name}\n\n${f.content}\n\n---\n\n`);
        
        // æ”¶é›†å…ƒæ•°æ®ç”¨äºUIæ˜¾ç¤º
        let sName = f.path.split("/").pop().replace(".md", "");
        if (f.type === 'quarter') meta.q.push(sName);
        else if (f.type === 'month') meta.m.push(sName);
        else if (f.type === 'week') meta.w.push(sName);
        else meta.d.push(sName);
    }
    
    return { text: textParts.join(""), count: results.length, meta, cutoff };
}

// ============================================================ 
// ğŸš€ UI æ¸²æŸ“å±‚ (UI Layer - Mobile Optimized)
// ============================================================ 

const rootNode = dv.container.createEl("div");
rootNode.innerHTML = `
<div style="padding: 20px; text-align: center; color: #888; border: 1px dashed #ccc; border-radius: 8px; margin-top: 10px;">
    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
    <div style="font-weight: bold; margin-bottom: 5px;">LifeBook å¼•æ“åŠ è½½ä¸­...</div>
    <div style="font-size: 12px; opacity: 0.8;">Reading IO from ${LB_CONFIG.months}m history...</div>
</div>`;

processLifeBook(LB_CONFIG).then((data) => {
    
    rootNode.innerHTML = "";
    
    let totalChars = data.text.length;
    let estTokens = Math.round(totalChars / 1.5);

	let header = document.createElement("h3");
	header.textContent = "ğŸµ LifeBook æ™ºèƒ½æ•°æ®åŒ…";
	header.style.marginBottom = "5px";
	rootNode.appendChild(header);
    
	let info = document.createElement("p");
	info.style.fontSize = "12px";
	info.style.color = "#666";
	info.style.margin = "0 0 10px 0";
	info.innerHTML = `
        <span style="margin-right: 10px;">ğŸ“… <b>å›æº¯</b>: ${LB_CONFIG.months}æœˆ</span>
        <span style="margin-right: 10px;">ğŸ“ <b>å­—ç¬¦</b>: ${totalChars}</span>
        <span>ğŸ§  <b>Token</b>: ~${estTokens}</span>
    `;

    rootNode.appendChild(info);

    function renderList(icon, list) {
        if (!list || list.length === 0) return "";
        let displayList = list.length > 5 ? list.slice(0, 5).concat([`... (+${list.length-5})`]) : list;
        return `<li><b>${icon} (${list.length})</b>: ${displayList.join(", ")}</li>`;
    }

    let contentDiv = document.createElement("div");
    contentDiv.innerHTML = `
    <div style="padding: 12px; background: rgba(100, 200, 100, 0.05); border-radius: 8px; border: 1px solid rgba(100, 200, 100, 0.1); font-size: 13px;">
        <h4 style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:5px; color: #2e7d32;">ğŸ“– LifeBook (Soul)</h4>
        <ul style="padding-left: 18px; margin: 0; line-height: 1.6;">
            ${renderList("ğŸ† å­£åº¦", data.meta.q)}
            ${renderList("ğŸŒ™ æœˆåº¦", data.meta.m)}
            ${renderList("ğŸ“† å‘¨åº¦", data.meta.w)}
            ${renderList("ğŸ“ æ—¥è®°", data.meta.d)}
        </ul>
        <div style="font-size:12px; color:#666; margin-top:5px;">Cutoff: ${data.cutoff}</div>
    </div>`;
    rootNode.appendChild(contentDiv);

    let btn = document.createElement("button");
    btn.textContent = "ğŸ“‹ å¤åˆ¶æ•°æ®åŒ… (Copy LifeBook)";
    btn.style.cssText = `
        margin-top: 15px; padding: 12px 20px; width: 100%; cursor: pointer;
        border-radius: 6px; border: 1px solid #ccc; background: #e0e0e0;
        color: #333; font-weight: bold; font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;
    `;
    
    btn.onmouseover = () => { btn.style.background = "#d0d0d0"; };
    btn.onmouseout = () => { btn.style.background = "#e0e0e0"; };

    btn.onclick = function() {
        let payload = `äº²çˆ±çš„ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„Lifebookè®°å¿†å›é¡¾æ•°æ®åŒ…ã€‚

ç°åœ¨æˆ‘å‘é€ç»™ä½ ä»¬ï¼Œä½ ä»¬ä½œä¸ºä¸Šä¸‹æ–‡äº†è§£å³å¯ï¼Œåœ¨ä½ ä»¬äº†è§£ä¹‹åæˆ‘ä¼šå’Œä½ ä»¬èŠçœŸæ­£æƒ³è¦èŠçš„å†…å®¹ã€‚

ğŸµ LifeBook æ™ºèƒ½æ•°æ®åŒ…
ç°åœ¨æ˜¯ ${moment().format("YYYY-MM-DD HH:mm")}

${data.text}`;
        
        navigator.clipboard.writeText(payload).then(() => {
            btn.textContent = "âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!";
            btn.style.background = "#d4edda";
            btn.style.borderColor = "#c3e6cb";
            btn.style.color = "#155724";
            
            setTimeout(() => { 
                btn.textContent = "ğŸ“‹ å¤åˆ¶æ•°æ®åŒ… (Copy LifeBook)"; 
                btn.style.background = "#e0e0e0"; 
                btn.style.borderColor = "#ccc";
                btn.style.color = "#333";
            }, 2000);
        });
    };
    rootNode.appendChild(btn);

}).catch(e => {
    rootNode.innerHTML = `<div style="color:red; padding:10px;">âŒ Error: ${e.message}</div>`;
});
```

