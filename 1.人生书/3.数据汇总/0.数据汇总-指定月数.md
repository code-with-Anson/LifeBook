
```dataviewjs
/* LifeBook Engine */

// ============================================================ 
// âš™ï¸ æ ¸å¿ƒé…ç½®åŒº (Configuration)
// ============================================================ 
const LB_CONFIG = {
    dir: "1.äººç”Ÿä¹¦/2.æ—¥è®°",
    months: 12 // å›æº¯æœˆä»½
};

// é™æ€æ­£åˆ™é¢„ç¼–è¯‘ (Performance Optimization)
const REGEX_Q = /(\d{4})å¹´Q(\d)/;
const REGEX_M = /(\d{4})å¹´(\d{1,2})æœˆ/;
const REGEX_W = /(\d{4})å¹´(\d{1,2})æœˆ.*[Ww](\d+)/;
const REGEX_DATE = /^\d{4}-\d{2}-\d{2}$/;

// ============================================================ 
// ğŸ› ï¸ æ ¸å¿ƒå¤„ç†å‡½æ•° (Core Processor)
// ============================================================ 
async function processLifeBook(config) {
    const now = moment();
    const startDate = now.clone().subtract(config.months, 'months').startOf('month');

    // 1. è·å–æ‰€æœ‰é¡µé¢
    let allPages = dv.pages(`"${config.dir}"`);
    let yList = [], qList = [], mList = [], wList = [], dList = [];

    // 2. éå†ä¸åˆæ­¥ç­›é€‰
    for (let p of allPages) {
        const name = p.file.name;

        // S. å¹´åº¦æ€»ç»“ (Supreme Layer)
        if (name.includes("å¹´å¹´åº¦æ€»ç»“") && name.startsWith("0-")) {
            const match = name.match(/0-(\d{4})å¹´å¹´åº¦æ€»ç»“/);
            if (match) {
                let y = parseInt(match[1]);
                let yDate = moment(`${y}-12-31`); // å¹´åº•
                if (yDate.isAfter(startDate)) {
                    yList.push({ p: p, y: y, sortKey: `${y}` });
                }
            }
            continue;
        }

        // A. å­£åº¦æ€»ç»“
        if (name.includes("å¹´Q") && name.includes("æ€»ç»“") && name.startsWith("0-")) {
            const match = name.match(REGEX_Q);
            if (match) {
                let y = parseInt(match[1]);
                let q = parseInt(match[2]);
                let qEndM = q * 3;
                let qEndDate = moment(`${y}-${qEndM}`, "YYYY-M").endOf('month');
                if (qEndDate.isAfter(startDate)) {
                    qList.push({ p: p, y: y, q: q, sortKey: `${y}-${q}Q` });
                }
            }
            continue;
        }

        // B. æœˆåº¦æ€»ç»“
        if (name.includes("æœˆæ€»ç»“") && name.startsWith("0-") && !name.includes("å‘¨") && !name.includes("W")) {
            const match = name.match(REGEX_M);
            if (match) {
                let mDate = moment(`${match[1]}-${match[2]}`, "YYYY-M").endOf('month');
                if (mDate.isAfter(startDate)) {
                    mList.push({ p: p, y: parseInt(match[1]), m: parseInt(match[2]), sortKey: `${match[1]}${match[2].padStart(2,'0')}` });
                }
            }
            continue;
        }

        // C. å‘¨åº¦æ€»ç»“
        if (name.includes("æ€»ç»“") && (name.includes("å‘¨") || name.includes("W"))) {
             const match = name.match(REGEX_W);
             if (match) {
                 let wEnd = moment(`${match[1]}-${match[2]}`, "YYYY-M").startOf('month').add(parseInt(match[3]) - 1, 'weeks').endOf('isoWeek');
                 if (wEnd.isAfter(startDate)) {
                     let monthKey = wEnd.format("YYYYMM");
                     wList.push({ p: p, name: name, wEnd: wEnd, monthKey: monthKey });
                 }
             }
             continue;
        }

        // D. æ—¥è®°
        if (!name.includes("æ€»ç»“") && REGEX_DATE.test(name)) {
            let dDate = moment(name.substring(0, 10));
            if (dDate.isValid() && dDate.isAfter(startDate)) {
                 let monthKey = dDate.format("YYYYMM");
                 dList.push({ p: p, name: name, date: dDate, monthKey: monthKey });
            }
            continue;
        }
    }

    // 3. é€»è¾‘æŠ˜å  (Cascading Filter)
    
    // Level 1: Year -> Quarter (å·²ç§»é™¤æŠ˜å é€»è¾‘)
    // å¹´åº¦æ€»ç»“ä¸åº”è¯¥éšè—å­£åº¦æ€»ç»“ï¼Œå®ƒä»¬æ˜¯å¹¶å­˜çš„ã€‚
    let visibleQuarters = qList; 

    // Level 2: Quarter -> Month
    let coveredMonths = new Set();
    
    // å¹´åº¦æ€»ç»“ä¸å†è¦†ç›–æœˆä»½ï¼Œåªæœ‰å­£åº¦æ€»ç»“è¦†ç›–æœˆä»½
    for (let qItem of visibleQuarters) {
        let startM = (qItem.q - 1) * 3 + 1;
        for (let i = 0; i < 3; i++) coveredMonths.add(`${qItem.y}${(startM + i).toString().padStart(2,'0')}`);
    }

    let visibleMonths = mList.filter(m => !coveredMonths.has(m.sortKey));
    let allCoveredMonths = new Set(coveredMonths);
    visibleMonths.forEach(m => allCoveredMonths.add(m.sortKey));

    // Level 3: Month -> Week
    let visibleWeeks = wList.filter(w => !allCoveredMonths.has(w.monthKey));

    // Level 4: Week -> Daily
    let cutoff = "0000-00-00";
    for (let w of visibleWeeks) {
        let wEndStr = w.wEnd.format("YYYY-MM-DD");
        if (wEndStr > cutoff) cutoff = wEndStr;
    }

    let visibleDailies = dList.filter(d => {
        if (allCoveredMonths.has(d.monthKey)) return false;
        if (d.name.substring(0, 10) <= cutoff) return false;
        return true;
    });

    // 4. å¹¶å‘åŠ è½½å†…å®¹
    let ioPromises = [];
    yList.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'year', name: "ğŸ‘‘ " + x.p.file.name, content: c, path: x.p.file.path }))));
    visibleQuarters.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'quarter', name: "ğŸ† " + x.p.file.name, content: c, path: x.p.file.path }))));
    visibleMonths.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'month', name: "ğŸŒ™ " + x.p.file.name, content: c, path: x.p.file.path }))));
    visibleWeeks.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'week', name: "ğŸ“† " + x.p.file.name, content: c, path: x.p.file.path }))));
    visibleDailies.forEach(x => ioPromises.push(dv.io.load(x.p.file.path).then(c => ({ type: 'daily', name: "ğŸ“ " + x.p.file.name, content: c, path: x.p.file.path }))));

    let results = await Promise.all(ioPromises);
    results.sort((a, b) => a.path.localeCompare(b.path));

    // 5. ç»“æœæ–‡æœ¬æ„å»º
    let textParts = [`# ğŸ“– LifeBook æ•°æ®å›é¡¾\n\n`];
    let meta = { y: [], q: [], m: [], w: [], d: [] };
    
    for (let f of results) {
        textParts.push(`## ${f.name}\n\n${f.content}\n\n---\n\n`);
        
        let sName = f.path.split("/").pop().replace(".md", "");
        if (f.type === 'year') meta.y.push(sName);
        else if (f.type === 'quarter') meta.q.push(sName);
        else if (f.type === 'month') meta.m.push(sName);
        else if (f.type === 'week') meta.w.push(sName);
        else meta.d.push(sName);
    }
    
    return { text: textParts.join(""), count: results.length, meta, cutoff };
}

// ============================================================ 
// ğŸš€ UI æ¸²æŸ“å±‚ (UI Layer - Mobile Optimized)
// ============================================================ 

const rootNode = dv.container.createEl("div");
rootNode.innerHTML = `
<div style="padding: 20px; text-align: center; color: #888; border: 1px dashed #ccc; border-radius: 8px; margin-top: 10px;">
    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”„</div>
    <div style="font-weight: bold; margin-bottom: 5px;">LifeBook å¼•æ“åŠ è½½ä¸­...</div>
    <div style="font-size: 12px; opacity: 0.8;">Reading IO from ${LB_CONFIG.months}m history...</div>
</div>`;

processLifeBook(LB_CONFIG).then((data) => {
    
    rootNode.innerHTML = "";
    
    let totalChars = data.text.length;
    let estTokens = Math.round(totalChars / 1.5);

	let header = document.createElement("h3");
	header.textContent = "ğŸµ LifeBook æ™ºèƒ½æ•°æ®åŒ…";
	header.style.marginBottom = "5px";
	rootNode.appendChild(header);
    
	let info = document.createElement("p");
	info.style.fontSize = "12px";
	info.style.color = "#666";
	info.style.margin = "0 0 10px 0";
	info.innerHTML = `
        <span style="margin-right: 10px;">ğŸ“… <b>å›æº¯</b>: ${LB_CONFIG.months}æœˆ</span>
        <span style="margin-right: 10px;">ğŸ“ <b>å­—ç¬¦</b>: ${totalChars}</span>
        <span>ğŸ§  <b>Token</b>: ~${estTokens}</span>
    `;

    rootNode.appendChild(info);

    function renderList(icon, list) {
        if (!list || list.length === 0) return "";
        let displayList = list.length > 5 ? list.slice(0, 5).concat([`... (+${list.length-5})`]) : list;
        return `<li><b>${icon} (${list.length})</b>: ${displayList.join(", ")}</li>`;
    }

    let contentDiv = document.createElement("div");
    contentDiv.innerHTML = `
    <div style="padding: 12px; background: rgba(100, 200, 100, 0.05); border-radius: 8px; border: 1px solid rgba(100, 200, 100, 0.1); font-size: 13px;">
        <h4 style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:5px; color: #2e7d32;">ğŸ“– LifeBook (Soul)</h4>
        <ul style="padding-left: 18px; margin: 0; line-height: 1.6;">
            ${renderList("ğŸ‘‘ å¹´åº¦", data.meta.y)}
            ${renderList("ğŸ† å­£åº¦", data.meta.q)}
            ${renderList("ğŸŒ™ æœˆåº¦", data.meta.m)}
            ${renderList("ğŸ“† å‘¨åº¦", data.meta.w)}
            ${renderList("ğŸ“ æ—¥è®°", data.meta.d)}
        </ul>
        <div style="font-size:12px; color:#666; margin-top:5px;">Cutoff: ${data.cutoff}</div>
    </div>`;
    rootNode.appendChild(contentDiv);

    let btn = document.createElement("button");
    btn.textContent = "ğŸ“‹ å¤åˆ¶æ•°æ®åŒ… (Copy LifeBook)";
    btn.style.cssText = `
        margin-top: 15px; padding: 12px 20px; width: 100%; cursor: pointer;
        border-radius: 6px; border: 1px solid #ccc; background: #e0e0e0;
        color: #333; font-weight: bold; font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;
    `;
    
    btn.onmouseover = () => { btn.style.background = "#d0d0d0"; };
    btn.onmouseout = () => { btn.style.background = "#e0e0e0"; };

    btn.onclick = function() {
        let payload = `äº²çˆ±çš„ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„Lifebookè®°å¿†å›é¡¾æ•°æ®åŒ…ã€‚

ç°åœ¨æˆ‘å‘é€ç»™ä½ ä»¬ï¼Œä½ ä»¬ä½œä¸ºä¸Šä¸‹æ–‡äº†è§£å³å¯ï¼Œåœ¨ä½ ä»¬äº†è§£ä¹‹åæˆ‘ä¼šå’Œä½ ä»¬èŠçœŸæ­£æƒ³è¦èŠçš„å†…å®¹ã€‚

ğŸµ LifeBook æ™ºèƒ½æ•°æ®åŒ…
ç°åœ¨æ˜¯ ${moment().format("YYYY-MM-DD HH:mm")}

${data.text}`;
        
        navigator.clipboard.writeText(payload).then(() => {
            btn.textContent = "âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!";
            btn.style.background = "#d4edda";
            btn.style.borderColor = "#c3e6cb";
            btn.style.color = "#155724";
            
            setTimeout(() => { 
                btn.textContent = "ğŸ“‹ å¤åˆ¶æ•°æ®åŒ… (Copy LifeBook)"; 
                btn.style.background = "#e0e0e0"; 
                btn.style.borderColor = "#ccc";
                btn.style.color = "#333";
            }, 2000);
        });
    };
    rootNode.appendChild(btn);

}).catch(e => {
    rootNode.innerHTML = `<div style="color:red; padding:10px;">âŒ Error: ${e.message}</div>`;
});
```

