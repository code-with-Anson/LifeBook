
### 季度回顾数据包（含当月日记）
````dataviewjs
/*
 * DataviewJS: 季度回顾数据包 (V1.0)
 * ---------------------------------
 * 目标:
 * 1. 自动抓取过去两个月的“月度总结”文件。
 * 2. 自动抓取当月的所有“日记”文件。
 * 3. 将所有文件内容按时间顺序合并。
 * 4. 提供一个“一键复制”按钮，用于生成“进行中”的季度回顾材料。
*/

// --- 1. 配置 ---
const FOLDER_PATH = "1.人生书/2.日记";
const SUMMARY_MONTHS_TO_FETCH = 3; // 抓取过去3个月的总结

// --- 2. 初始化 ---
const now = moment();
const currentYear = now.format("YYYY");
const currentMonth = now.format("MM");
let promises = [];

// --- 3. 抓取过去月份的“月度总结” ---
for (let i = 1; i <= SUMMARY_MONTHS_TO_FETCH; i++) {
    let targetMoment = now.clone().subtract(i, 'months');
    let year = targetMoment.format("YYYY");
    let month = targetMoment.format("MM");
    let summaryPath = `${FOLDER_PATH}/${year}/${month}/0-${year}年${month}月总结.md`;
    
    if (dv.page(summaryPath)) {
        promises.push(dv.io.load(summaryPath).then(content => ({
            path: summaryPath,
            content: content,
            type: 'summary'
        })));
    }
}

// --- 4. 抓取当月的“每日日记” ---
const dailyNotesPattern = `"${FOLDER_PATH}/${currentYear}/${currentMonth}"`;
const dailyPages = dv.pages(dailyNotesPattern)
    .where(p => !p.file.name.includes("总结")); // 排除月度总结文件

for (let page of dailyPages) {
    let dailyPath = page.file.path;
    promises.push(dv.io.load(dailyPath).then(content => ({
        path: dailyPath,
        content: content,
        type: 'daily'
    })));
}

// --- 5. 等待所有文件加载完毕后处理 ---
Promise.all(promises).then(results => {
    const allPages = results.filter(p => p !== null);

    // 按文件路径（日期）排序，确保时间线正确
    allPages.sort((a, b) => a.path.localeCompare(b.path));

    // --- 6. 拼接内容 ---
    let contentToCopy = "";
    let summaryFiles = [];
    let dailyFileCount = 0;
    let charCount = 0;

    for (let page of allPages) {
        const fileName = page.path.split('/').pop();
        if (page.type === 'summary') {
            summaryFiles.push("`" + fileName + "`");
        } else {
            dailyFileCount++;
        }
        const pageContent = `\n\n---\n\n## 🔗 ${fileName}\n\n${page.content}`;
        contentToCopy += pageContent;
        charCount += pageContent.length;
    }

    // --- 7. 准备统计信息和最终要复制的文本 ---
    const statsHeader = `📊 成功汇总了 ${summaryFiles.length} 个月度总结和 ${dailyFileCount} 篇本月日记，共约 ${charCount} 字。`;
    const statsFiles = summaryFiles.length > 0 ? `包含总结: ${summaryFiles.join(" ")}` : "";
    const finalContent = statsHeader + "\n" + statsFiles + "\n" + contentToCopy;

    // --- 8. 渲染“一键复制”按钮 ---
    const button = dv.el("button", "📋 一键复制季度回顾数据包");
    button.onclick = () => {
        navigator.clipboard.writeText(finalContent).then(() => {
            button.innerText = "✅ 已复制到剪贴板!";
            setTimeout(() => { button.innerText = "📋 一键复制季度回顾数据包"; }, 2000);
        }, () => {
            button.innerText = "❌ 复制失败 (请检查权限)";
        });
    };

    // --- 9. 渲染最终结果到页面 ---
    dv.el("div", button);
    dv.el("h4", statsHeader);
    if (summaryFiles.length > 0) {
        dv.el("p", statsFiles);
    }
});
````

